name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
      - codespace-special-eureka-5g4r69vvvjh46p9
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  GAR_LOCATION: us-central1-docker.pkg.dev
  FRONTEND_SERVICE: visashield-frontend
  BACKEND_SERVICE: visashield-backend
  REPOSITORY: visashield

jobs:
  # Build and Deploy Backend
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

      - name: Create Artifact Registry Repository (if not exists)
        run: |
          gcloud artifacts repositories describe ${{ env.REPOSITORY }} \
            --location=${{ env.REGION }} || \
          gcloud artifacts repositories create ${{ env.REPOSITORY }} \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="VisaShield Docker images"

      - name: Build and Push Backend Image
        working-directory: ./visashieldai
        run: |
          IMAGE_TAG="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_SERVICE }}:latest"
          
          docker build \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --build-arg AGENT_VERSION=${{ github.run_number }} \
            -t $IMAGE_TAG \
            -t $IMAGE_LATEST \
            .
          
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=2Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="DD_ENV=${{ inputs.environment || 'development' }}" \
            --set-env-vars="DD_SERVICE=${{ env.BACKEND_SERVICE }}" \
            --set-env-vars="DD_VERSION=${{ github.sha }}" \
            --set-env-vars="DD_LOGS_INJECTION=true" \
            --set-env-vars="DD_TRACE_SAMPLE_RATE=1" \
            --set-env-vars="DD_APPSEC_ENABLED=true" \
            --set-env-vars="DD_LLMOBS_ENABLED=1" \
            --set-env-vars="DD_LLMOBS_ML_APP=visaAI" \
            --set-secrets="DD_API_KEY=datadog-api-key:latest" \
            --set-secrets="GOOGLE_API_KEY=google-api-key:latest" \
            --timeout=300

      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend deployed at: $BACKEND_URL"

    outputs:
      backend_url: ${{ steps.backend-url.outputs.BACKEND_URL }}

  # Build and Deploy Frontend
  deploy-frontend:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: deploy-backend
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Angular app
        working-directory: ./frontend
        run: |
          npm run build -- --configuration=production
        env:
          BACKEND_URL: ${{ needs.deploy-backend.outputs.backend_url }}

      - name: Create Frontend Dockerfile
        working-directory: ./frontend
        run: |
          cat > Dockerfile << 'EOF'
          FROM nginx:alpine
          
          # Copy nginx configuration
          COPY nginx.conf /etc/nginx/nginx.conf
          
          # Copy built Angular app
          COPY dist/visa-shield/browser /usr/share/nginx/html
          
          # Expose port 8080 for Cloud Run
          EXPOSE 8080
          
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Create Nginx config
        working-directory: ./frontend
        run: |
          cat > nginx.conf << 'EOF'
          worker_processes auto;
          error_log /var/log/nginx/error.log warn;
          pid /tmp/nginx.pid;
          
          events {
              worker_connections 1024;
          }
          
          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;
              
              log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                              '$status $body_bytes_sent "$http_referer" '
                              '"$http_user_agent" "$http_x_forwarded_for"';
              
              access_log /var/log/nginx/access.log main;
              
              sendfile on;
              keepalive_timeout 65;
              gzip on;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
              
              server {
                  listen 8080;
                  server_name _;
                  root /usr/share/nginx/html;
                  index index.html;
                  
                  # Security headers
                  add_header X-Frame-Options "SAMEORIGIN" always;
                  add_header X-Content-Type-Options "nosniff" always;
                  add_header X-XSS-Protection "1; mode=block" always;
                  
                  # Handle Angular routing
                  location / {
                      try_files $uri $uri/ /index.html;
                  }
                  
                  # Cache static assets
                  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
                  
                  # Health check endpoint
                  location /health {
                      access_log off;
                      return 200 'OK';
                      add_header Content-Type text/plain;
                  }
              }
          }
          EOF

      - name: Build and Push Frontend Image
        working-directory: ./frontend
        run: |
          IMAGE_TAG="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_SERVICE }}:latest"
          
          docker build \
            -t $IMAGE_TAG \
            -t $IMAGE_LATEST \
            .
          
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="BACKEND_URL=${{ needs.deploy-backend.outputs.backend_url }}" \
            --timeout=60

      - name: Get Frontend URL
        run: |
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "Frontend deployed at: $FRONTEND_URL"
          echo "## üöÄ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $FRONTEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.outputs.backend_url }} |" >> $GITHUB_STEP_SUMMARY

  # Notify on completion
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          if [ "${{ needs.deploy-frontend.result }}" == "success" ] && [ "${{ needs.deploy-backend.result }}" == "success" ]; then
            echo "‚úÖ All deployments successful!"
            echo "Backend: ${{ needs.deploy-backend.outputs.backend_url }}"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi
