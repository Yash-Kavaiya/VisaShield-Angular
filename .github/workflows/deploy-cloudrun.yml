name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  GAR_LOCATION: us-central1-docker.pkg.dev
  FRONTEND_SERVICE: visashield-frontend
  BACKEND_SERVICE: visashield-backend
  REPOSITORY: visashield
  ENVIRONMENT: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
  # Workload Identity Federation settings
  WORKLOAD_IDENTITY_PROVIDER: projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-actions@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com

jobs:
  # Check if secrets are configured
  check-secrets:
    name: Check Required Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_configured: ${{ steps.check.outputs.configured }}
    steps:
      - name: Check if secrets are configured
        id: check
        env:
          HAS_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID != '' }}
          HAS_PROJECT_NUMBER: ${{ secrets.GCP_PROJECT_NUMBER != '' }}
        run: |
          echo "Checking secrets configuration..."
          
          if [ "$HAS_PROJECT_ID" != "true" ]; then
            echo "‚ùå GCP_PROJECT_ID secret is not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "$HAS_PROJECT_NUMBER" != "true" ]; then
            echo "‚ùå GCP_PROJECT_NUMBER secret is not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ Required secrets are configured"
          echo "configured=true" >> $GITHUB_OUTPUT

      - name: Show setup instructions if secrets missing
        if: steps.check.outputs.configured == 'false'
        run: |
          echo "## ‚ö†Ô∏è GitHub Secrets Not Configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please configure the following secrets in your repository:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Secrets (2 secrets only!):" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | How to Get |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`GCP_PROJECT_ID\` | \`gcloud config get-value project\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`GCP_PROJECT_NUMBER\` | \`gcloud projects describe \$(gcloud config get-value project) --format='value(projectNumber)'\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### One-Time GCP Setup (run these commands once):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Set variables" >> $GITHUB_STEP_SUMMARY
          echo "export PROJECT_ID=\$(gcloud config get-value project)" >> $GITHUB_STEP_SUMMARY
          echo "export PROJECT_NUMBER=\$(gcloud projects describe \$PROJECT_ID --format='value(projectNumber)')" >> $GITHUB_STEP_SUMMARY
          echo "export REPO='Yash-Kavaiya/VisaShield-Angular'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Enable APIs" >> $GITHUB_STEP_SUMMARY
          echo "gcloud services enable iamcredentials.googleapis.com run.googleapis.com artifactregistry.googleapis.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Create Workload Identity Pool" >> $GITHUB_STEP_SUMMARY
          echo "gcloud iam workload-identity-pools create github-pool --location='global'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Create Provider" >> $GITHUB_STEP_SUMMARY
          echo "gcloud iam workload-identity-pools providers create-oidc github-provider \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --location='global' --workload-identity-pool='github-pool' \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --issuer-uri='https://token.actions.githubusercontent.com' \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --attribute-mapping='google.subject=assertion.sub,attribute.repository=assertion.repository'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Create Service Account" >> $GITHUB_STEP_SUMMARY
          echo "gcloud iam service-accounts create github-actions --display-name='GitHub Actions'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Grant permissions" >> $GITHUB_STEP_SUMMARY
          echo "for role in run.admin artifactregistry.admin iam.serviceAccountUser storage.admin; do" >> $GITHUB_STEP_SUMMARY
          echo "  gcloud projects add-iam-policy-binding \$PROJECT_ID \\\\" >> $GITHUB_STEP_SUMMARY
          echo "    --member='serviceAccount:github-actions@\$PROJECT_ID.iam.gserviceaccount.com' \\\\" >> $GITHUB_STEP_SUMMARY
          echo "    --role='roles/\$role'" >> $GITHUB_STEP_SUMMARY
          echo "done" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Allow GitHub to impersonate the service account" >> $GITHUB_STEP_SUMMARY
          echo "gcloud iam service-accounts add-iam-policy-binding github-actions@\$PROJECT_ID.iam.gserviceaccount.com \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --role='roles/iam.workloadIdentityUser' \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --member='principalSet://iam.googleapis.com/projects/\$PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/attribute.repository/\$REPO'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit 1

  # CI: Build, Test, Lint
  ci:
    name: CI - Test and Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Lint and test frontend
        working-directory: ./frontend
        run: |
          npm run test -- --watch=false --browsers=ChromeHeadless

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/0.8.13/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install backend dependencies
        working-directory: ./visashieldai
        run: uv sync --dev --extra lint

      - name: Lint backend
        working-directory: ./visashieldai
        run: |
          uv run codespell
          uv run ruff check .
          uv run ruff format . --check
          uv run mypy .

      - name: Test backend
        working-directory: ./visashieldai
        run: uv run pytest tests/unit tests/integration

  # Build and Deploy Backend
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    needs: [check-secrets, ci]
    if: needs.check-secrets.outputs.secrets_configured == 'true' && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

      - name: Create Artifact Registry Repository (if not exists)
        run: |
          gcloud artifacts repositories describe ${{ env.REPOSITORY }} \
            --location=${{ env.REGION }} 2>/dev/null || \
          gcloud artifacts repositories create ${{ env.REPOSITORY }} \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="VisaShield Docker images"

      - name: Build and Push Backend Image
        working-directory: ./visashieldai
        run: |
          IMAGE_TAG="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_SERVICE }}:latest"
          
          docker build \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --build-arg AGENT_VERSION=${{ github.run_number }} \
            -t $IMAGE_TAG \
            -t $IMAGE_LATEST \
            .
          
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=2Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="DD_ENV=${{ env.ENVIRONMENT }}" \
            --set-env-vars="DD_SERVICE=${{ env.BACKEND_SERVICE }}" \
            --set-env-vars="DD_VERSION=${{ github.sha }}" \
            --set-env-vars="DD_LOGS_INJECTION=true" \
            --set-env-vars="DD_TRACE_SAMPLE_RATE=1" \
            --set-env-vars="DD_APPSEC_ENABLED=true" \
            --set-env-vars="DD_LLMOBS_ENABLED=1" \
            --set-env-vars="DD_LLMOBS_ML_APP=visaAI" \
            --timeout=300

      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend deployed at: $BACKEND_URL"

    outputs:
      backend_url: ${{ steps.backend-url.outputs.BACKEND_URL }}

  # Build and Deploy Frontend
  deploy-frontend:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: [check-secrets, deploy-backend]
    if: needs.check-secrets.outputs.secrets_configured == 'true' && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Angular app
        working-directory: ./frontend
        run: |
          npm run build -- --configuration=production
        env:
          BACKEND_URL: ${{ needs.deploy-backend.outputs.backend_url }}

      - name: Build and Push Frontend Image
        working-directory: ./frontend
        run: |
          IMAGE_TAG="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_SERVICE }}:latest"
          
          docker build \
            -t $IMAGE_TAG \
            -t $IMAGE_LATEST \
            .
          
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="BACKEND_URL=${{ needs.deploy-backend.outputs.backend_url }}" \
            --timeout=60

      - name: Get Frontend URL
        run: |
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "Frontend deployed at: $FRONTEND_URL"
          echo "## üöÄ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $FRONTEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.outputs.backend_url }} |" >> $GITHUB_STEP_SUMMARY

  # Notify on completion
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [check-secrets, deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          if [ "${{ needs.check-secrets.outputs.secrets_configured }}" != "true" ]; then
            echo "‚ùå Deployment skipped - secrets not configured"
            echo "Please configure GCP_PROJECT_ID and GCP_PROJECT_NUMBER in repository secrets"
            exit 1
          elif [ "${{ needs.deploy-frontend.result }}" == "success" ] && [ "${{ needs.deploy-backend.result }}" == "success" ]; then
            echo "‚úÖ All deployments successful!"
            echo "Backend: ${{ needs.deploy-backend.outputs.backend_url }}"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi
