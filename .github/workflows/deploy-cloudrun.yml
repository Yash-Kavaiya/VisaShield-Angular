name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
      - codespace-special-eureka-5g4r69vvvjh46p9
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  GAR_LOCATION: us-central1-docker.pkg.dev
  FRONTEND_SERVICE: visashield-frontend
  BACKEND_SERVICE: visashield-backend
  REPOSITORY: visashield

jobs:
  # Check if secrets are configured
  check-secrets:
    name: Check Required Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_configured: ${{ steps.check.outputs.configured }}
      auth_method: ${{ steps.check.outputs.auth_method }}
    steps:
      - name: Check if secrets are configured
        id: check
        env:
          HAS_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID != '' }}
          HAS_SA_KEY: ${{ secrets.GCP_SA_KEY != '' }}
          HAS_WIF: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER != '' }}
        run: |
          echo "Checking secrets configuration..."
          
          if [ "$HAS_PROJECT_ID" != "true" ]; then
            echo "‚ùå GCP_PROJECT_ID secret is not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "auth_method=none" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "$HAS_SA_KEY" == "true" ]; then
            echo "‚úÖ Using Service Account Key authentication"
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "auth_method=sa_key" >> $GITHUB_OUTPUT
          elif [ "$HAS_WIF" == "true" ]; then
            echo "‚úÖ Using Workload Identity Federation authentication"
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "auth_method=wif" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No authentication method configured"
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "auth_method=none" >> $GITHUB_OUTPUT
          fi

      - name: Show setup instructions if secrets missing
        if: steps.check.outputs.configured == 'false'
        run: |
          echo "## ‚ö†Ô∏è GitHub Secrets Not Configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please configure the following secrets in your repository:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "1. **GCP_PROJECT_ID** - Your Google Cloud Project ID" >> $GITHUB_STEP_SUMMARY
          echo "2. **GCP_SA_KEY** - Service Account JSON key" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Setup Instructions:" >> $GITHUB_STEP_SUMMARY
          echo "See .github/DEPLOYMENT.md for detailed setup instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Setup:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Create service account" >> $GITHUB_STEP_SUMMARY
          echo "gcloud iam service-accounts create github-actions --display-name='GitHub Actions'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Grant permissions" >> $GITHUB_STEP_SUMMARY
          echo "gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \\" >> $GITHUB_STEP_SUMMARY
          echo "  --member='serviceAccount:github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --role='roles/run.admin'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Create key" >> $GITHUB_STEP_SUMMARY
          echo "gcloud iam service-accounts keys create key.json \\" >> $GITHUB_STEP_SUMMARY
          echo "  --iam-account=github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Copy contents of key.json to GCP_SA_KEY secret" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit 1

  # Build and Deploy Backend
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.secrets_configured == 'true'
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth (Service Account Key)
        if: needs.check-secrets.outputs.auth_method == 'sa_key'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Google Auth (Workload Identity)
        if: needs.check-secrets.outputs.auth_method == 'wif'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

      - name: Create Artifact Registry Repository (if not exists)
        run: |
          gcloud artifacts repositories describe ${{ env.REPOSITORY }} \
            --location=${{ env.REGION }} 2>/dev/null || \
          gcloud artifacts repositories create ${{ env.REPOSITORY }} \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="VisaShield Docker images"

      - name: Build and Push Backend Image
        working-directory: ./visashieldai
        run: |
          IMAGE_TAG="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_SERVICE }}:latest"
          
          docker build \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --build-arg AGENT_VERSION=${{ github.run_number }} \
            -t $IMAGE_TAG \
            -t $IMAGE_LATEST \
            .
          
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=2Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="DD_ENV=${{ inputs.environment || 'development' }}" \
            --set-env-vars="DD_SERVICE=${{ env.BACKEND_SERVICE }}" \
            --set-env-vars="DD_VERSION=${{ github.sha }}" \
            --set-env-vars="DD_LOGS_INJECTION=true" \
            --set-env-vars="DD_TRACE_SAMPLE_RATE=1" \
            --set-env-vars="DD_APPSEC_ENABLED=true" \
            --set-env-vars="DD_LLMOBS_ENABLED=1" \
            --set-env-vars="DD_LLMOBS_ML_APP=visaAI" \
            --timeout=300

      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend deployed at: $BACKEND_URL"

    outputs:
      backend_url: ${{ steps.backend-url.outputs.BACKEND_URL }}

  # Build and Deploy Frontend
  deploy-frontend:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: [check-secrets, deploy-backend]
    if: needs.check-secrets.outputs.secrets_configured == 'true'
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth (Service Account Key)
        if: needs.check-secrets.outputs.auth_method == 'sa_key'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Google Auth (Workload Identity)
        if: needs.check-secrets.outputs.auth_method == 'wif'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Angular app
        working-directory: ./frontend
        run: |
          npm run build -- --configuration=production
        env:
          BACKEND_URL: ${{ needs.deploy-backend.outputs.backend_url }}

      - name: Build and Push Frontend Image
        working-directory: ./frontend
        run: |
          IMAGE_TAG="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_SERVICE }}:latest"
          
          docker build \
            -t $IMAGE_TAG \
            -t $IMAGE_LATEST \
            .
          
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="BACKEND_URL=${{ needs.deploy-backend.outputs.backend_url }}" \
            --timeout=60

      - name: Get Frontend URL
        run: |
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "Frontend deployed at: $FRONTEND_URL"
          echo "## üöÄ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $FRONTEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.outputs.backend_url }} |" >> $GITHUB_STEP_SUMMARY

  # Notify on completion
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [check-secrets, deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          if [ "${{ needs.check-secrets.outputs.secrets_configured }}" != "true" ]; then
            echo "‚ùå Deployment skipped - secrets not configured"
            echo "Please configure GCP_PROJECT_ID and GCP_SA_KEY in repository secrets"
            echo "Go to: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          elif [ "${{ needs.deploy-frontend.result }}" == "success" ] && [ "${{ needs.deploy-backend.result }}" == "success" ]; then
            echo "‚úÖ All deployments successful!"
            echo "Backend: ${{ needs.deploy-backend.outputs.backend_url }}"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi
